generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  avatar_url   String?
  private_key  String
  wallet_address String @unique
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  machines     Machine[]

  @@map("users")
}

model Machine {
  id                      String   @id @default(cuid())
  api_key                 String   @unique
  owner_id                String
  machine_contract_address String
  price                   Float    @default(0.0)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  
  owner User @relation(fields: [owner_id], references: [id], onDelete: Cascade)

  @@map("machines")
}

// Vend402 Models (Stellar Payments)
model Vend402Challenge {
  id          String   @id @default(uuid())
  challenge_id String  @unique
  device_id   String
  amount      String
  destination String
  memo        String
  expires_at  DateTime
  created_at  DateTime @default(now())

  @@index([device_id])
  @@index([expires_at])
  @@map("vend402_challenges")
}

model Vend402Payment {
  id          String   @id @default(uuid())
  challenge_id String
  device_id   String
  amount      String
  asset       String
  tx_hash     String   @unique
  status      String   @default("pending") // pending | verified | settled | failed
  created_at  DateTime @default(now())
  verified_at DateTime?
  settled_at  DateTime?

  @@index([device_id])
  @@index([tx_hash])
  @@map("vend402_payments")
}